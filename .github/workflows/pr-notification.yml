name: PR Slack Notification

on:
  pull_request:
    types: [review_requested]
    branches: [main, develop]
  pull_request_review:
    types: [submitted]

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Send Slack Notification
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          EVENT_NAME="${{ github.event_name }}"

          # GitHub ìœ ì €ë„¤ì„ -> Slack User ID ë§¤í•‘
          get_slack_user_id() {
            case "$1" in
              "hyun907")
                echo "U0A6NAVG516"
                ;;
              "ssilver01")
                echo "U0A5KB81ND9"
                ;;
              *)
                echo "$1"  # ë§¤í•‘ì´ ì—†ìœ¼ë©´ GitHub ìœ ì €ë„¤ì„ ê·¸ëŒ€ë¡œ
                ;;
            esac
          }

          if [ "$EVENT_NAME" == "pull_request_review" ]; then
            REVIEW_STATE="${{ github.event.review.state }}"
            # approvedì¼ ë•Œë§Œ ì•Œë¦¼
            if [ "$REVIEW_STATE" == "approved" ]; then
              REVIEWER="${{ github.event.review.user.login }}"
              PR_AUTHOR_SLACK_ID=$(get_slack_user_id "$PR_AUTHOR")
              MESSAGE="âœ… *PR ìŠ¹ì¸! ë¦¬ë·° í™•ì¸í•˜ëŸ¬ ì™€ì£¼ì„¸ìš”*\n\n<@${PR_AUTHOR_SLACK_ID}> *ìŠ¹ì¸ì:* ${REVIEWER}\n*ì œëª©:* ${PR_TITLE} (#${PR_NUMBER})\n*ë§í¬:* ${PR_URL}"
            else
              exit 0  # ì½”ë©˜íŠ¸ë‚˜ ë³€ê²½ìš”ì²­ì€ ì•Œë¦¼ ì•ˆ ë³´ëƒ„
            fi
          else
            # ë¦¬ë·° ìš”ì²­ëœ ì‚¬ëŒ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            REQUESTED_REVIEWER="${{ github.event.requested_reviewer.login }}"
            if [ -z "$REQUESTED_REVIEWER" ]; then
              # íŒ€ì´ ìš”ì²­ëœ ê²½ìš°
              REQUESTED_TEAM="${{ github.event.requested_team.name }}"
              MESSAGE="ğŸ‘€ *ë¦¬ë·° ìš”ì²­!*\n\n*ìš”ì²­ ëŒ€ìƒ:* @${REQUESTED_TEAM} íŒ€\n*ì œëª©:* ${PR_TITLE} (#${PR_NUMBER})\n*ì‘ì„±ì:* ${PR_AUTHOR}\n*ë§í¬:* ${PR_URL}"
            else
              SLACK_USER_ID=$(get_slack_user_id "$REQUESTED_REVIEWER")
              MESSAGE="ğŸ‘€ *ë¦¬ë·° ìš”ì²­!*\n\n<@${SLACK_USER_ID}> ë¦¬ë·° ë¶€íƒë“œë ¤ìš”!\n*ì œëª©:* ${PR_TITLE} (#${PR_NUMBER})\n*ì‘ì„±ì:* ${PR_AUTHOR}\n*ë§í¬:* ${PR_URL}"
            fi
          fi

          curl -X POST \
            -H 'Content-type: application/json' \
            --data "{
              \"text\": \"${MESSAGE}\"
            }" \
            ${{ secrets.SLACK_WEBHOOK_URL }}
